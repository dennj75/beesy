<!DOCTYPE html>
<html lang="it">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nuova transazione</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
  </head>
  <body>
    <h1>â• Aggiungi una nuova transazione</h1>
    <form method="post" action="{{ url_for('nuova_transazione') }}">
      
      <label for="data">ğŸ“… Data (YYYY-MM-DD):</label><br />
      <input type="date" id="data" name="data" required value="{{ transazione['data'] if transazione else '' }}" /><br /><br />

      <label for="descrizione">ğŸ“Descrizione:</label><br />
      <input type="text" id="descrizione" name="descrizione" required value="{{ transazione.descrizione if transazione else '' }}" /><br /><br />

      <label>Categoria:</label><br>
      <select name="categoria" id="categoria" onchange="popolaSottocategoria()" required>
        <option value="">-- Seleziona Categoria --</option>
        {% for cat in categorie %}
          <option value="{{ cat }}" {% if transazione and transazione.categoria == cat %}selected{% endif %}>{{ cat }}</option>
        {% endfor %}
      </select><br><br>

      <label>Sottocategoria:</label><br>
      <select name="sottocategoria" id="sottocategoria" required>
        {% if transazione %}
          <option value="{{ transazione.sottocategoria }}">{{ transazione.sottocategoria }}</option>
        {% endif %}
      </select><br><br>

      <label for="importo">ğŸ’¸ Importo (â‚¬):</label><br />
      <input type="text" id="importo" name="importo" step="0.01" required value="{{ transazione.importo if transazione else '' }}" />
      <br><br>
      <label for="conto">Conto:</label><br>
      <select name="conto" id="conto" required>
        <option value="BANCA">ğŸ¦ Banca</option>
        <option value="CONTANTI">ğŸ’¶ Contanti</option>
      </select>
      <br><br>
      <button type="submit">âœ… Aggiungi</button>
    </form>    

    <p><a href="{{ url_for('transazioni') }}">â¬…ï¸ Torna alle transazioni</a></p>
  </body>
</html>

<script>
  const categorie = {{ categorie_json | safe }};
  const sottocategoriaAttuale = "{{ transazione['sottocategoria'] if transazione else '' }}";

  function popolaSottocategoria() {
    const categoriaSelezionata = document.getElementById("categoria").value;
    const sottoSel = document.getElementById("sottocategoria");
    sottoSel.innerHTML = "";

    if (categorie[categoriaSelezionata]) {
      categorie[categoriaSelezionata].forEach(sotto => {
        const opt = document.createElement("option");
        opt.value = sotto;
        opt.text = sotto;
        if (sotto === sottocategoriaAttuale) opt.selected = true;
        sottoSel.appendChild(opt);
      });
    } else {
      const opt = document.createElement("option");
      opt.value = "";
      opt.text = "-- Nessuna sottocategoria --";
      sottoSel.appendChild(opt);
    }
  }

  document.addEventListener("DOMContentLoaded", () => popolaSottocategoria());
</script>
